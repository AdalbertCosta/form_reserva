<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitação de Demandas - Reserva Universitário</title>
  <meta name="description" content="Envie sua solicitação de demandas para o condomínio de forma rápida e organizada.">
  <link rel="icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./css/style.min.css">
  <link rel="stylesheet" href="./css/formulario.css">
  <script>document.documentElement.classList.add('js');</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html { scroll-behavior: smooth; }
    .toast {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 22px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      z-index: 9999;
      color: #fff;
      background-color: #33B37A;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      animation: fadeInOut 4s forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      10%, 90% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, 20px); }
    }
  </style>
</head>

<body>
  <header class="header-bg">
    <div class="header container">
      <a href="index.html">
        <img src="./img/bikcraft.svg" width="136" height="32" alt="Conectta">
      </a>
      <nav aria-label="primaria">
        <ul class="header-menu font-1-m cor-0">
          <li><a href="index.html">Página Inicial</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section id="demandas">
      <div class="titulo-bg">
        <div class="titulo container">
          <p class="font-2-l-b cor-5">Formulário de Solicitação</p>
          <h1 class="font-1-xxl cor-0">Envie sua Demanda<span class="cor-p1">.</span></h1>
        </div>
      </div>

      <form id="demandasForm" class="orcamento container" enctype="multipart/form-data">
        <div class="orcamento-produto">
          <h2 class="font-1-xs cor-5">Horário de análise das demandas: 17h45 às 19h00 (Seg a Sex)</h2>
        </div>

        <div class="orcamento-dados form">
          <h2 class="font-1-xs cor-9 col-2">Dados do Solicitante</h2>
          <div><label for="nome">Nome *</label><input type="text" id="nome" required></div>
          <div><label for="numero_casa">Número da Casa *</label><input type="text" id="numero_casa" required></div>
          <div class="col-2"><label for="whatsapp">WhatsApp</label><input type="text" id="whatsapp" placeholder="(51) 99999-9999"></div>
          <div class="col-2"><label for="email">E-mail</label><input type="email" id="email"></div>

          <h2 class="font-1-xs cor-9 col-2">Perfil</h2>
          <div class="col-2">
            <label for="tipo_pessoa">Você é:</label>
            <select id="tipo_pessoa" required>
              <option value="">Selecione</option>
              <option value="Proprietário">Proprietário</option>
              <option value="Inquilino">Inquilino</option>
            </select>
          </div>

          <h2 class="font-1-xs cor-9 col-2">Tipo de Solicitação *</h2>
          <div class="col-2">
            <select id="tipo_solicitacao" required>
              <option value="">Selecione</option>
              <option value="Solicitação de Reparos/Serviços">Solicitação de Reparos/Serviços</option>
              <option value="Informe/Reclamação">Informe/Reclamação</option>
              <option value="Agendamento Salão de Festas">Agendamento Salão de Festas</option>
              <option value="Sugestão de Melhoria">Sugestão de Melhoria</option>
              <option value="Pedido de Informação">Pedido de Informação</option>
            </select>
          </div>

          <div class="col-2">
            <label for="descricao">Descrição da Solicitação *</label>
            <textarea id="descricao" rows="6" required></textarea>
          </div>

          <h2 class="font-1-xs cor-9 col-2">Anexar Imagem (opcional)</h2>
          <div class="col-2"><input type="file" id="imagem" accept="image/*"></div>

          <h2 class="font-1-xs cor-9 col-2">Prioridade</h2>
          <div class="col-2">
            <select id="prioridade" name="prioridade">
              <option value="">Selecione</option>
              <option value="Baixa">Baixa</option>
              <option value="Normal">Normal</option>
              <option value="Alta">Alta</option>
            </select>
          </div>

          <input type="hidden" id="condominio_id" value="36d1c597-2b15-480d-8cd0-fde265ed416a">
          <input type="hidden" id="usuario_id" value="">
          <input type="hidden" id="bloco_id" value="">
          <input type="hidden" id="origem" value="Plataforma Web">
          <input type="hidden" id="origem_login" value="morador">

          <button type="submit" class="botao col-2">Enviar Solicitação</button>
        </div>
      </form>
    </section>
  </main>

  <footer class="footer-bg">
    <div class="footer container">
      <img src="./img/bikcraft.svg" alt="Conectta">
      <div class="footer-contato">
        <h3 class="font-2-l-b cor-0">Contato</h3>
        <ul class="font-2-m cor-5">
          <li><a href="https://wa.me/5551982712025" target="_blank">+55 51 98271-2025</a></li>
          <li><a href="mailto:condreserva771@gmail.com">condreserva771@gmail.com</a></li>
          <li>Rua Pedro Petry, 771 - Universitário</li>
          <li>Lajeado - RS</li>
        </ul>
      </div>
    </div>
  </footer>

<script>
  const SUPABASE_URL = "https://imfmysuckcqocfrifele.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZm15c3Vja2Nxb2NmcmlmZWxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzE4OTksImV4cCI6MjA3MzU0Nzg5OX0.adD92pCg4q3l6VlIdUby3ozD4l_HyvY2xMrygT3LxF8";

  const form = document.getElementById("demandasForm");
  const botao = form.querySelector("button[type='submit']");

  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.style.backgroundColor = type === "error" ? "#C0392B" : "#33B37A";
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    botao.disabled = true;
    botao.textContent = "Enviando...";

    const dados = {
      id: crypto.randomUUID(),
      nome_solicitante: document.getElementById("nome").value.trim(),
      numero_casa: document.getElementById("numero_casa").value.trim(),
      whatsapp: document.getElementById("whatsapp").value.trim(),
      email: document.getElementById("email").value.trim(),
      tipo_pessoa: document.getElementById("tipo_pessoa").value,
      tipo_solicitacao: document.getElementById("tipo_solicitacao").value,
      descricao: document.getElementById("descricao").value.trim(),
      prioridade: document.getElementById("prioridade").value || "Normal",
      condominio_id: document.getElementById("condominio_id").value,
      usuario_id: document.getElementById("usuario_id").value || null,
      bloco_id: document.getElementById("bloco_id").value || null,
      origem: "Plataforma Web",
      origem_login: "morador",
      status: "Aberta",
      imagem_url: null,
      created_at: new Date().toISOString(),
    };

    if (!dados.condominio_id || !dados.tipo_solicitacao || !dados.descricao) {
      showToast("⚠️ Preencha todos os campos obrigatórios.", "error");
      botao.disabled = false;
      botao.textContent = "Enviar Solicitação";
      return;
    }

    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/demandas`, {
        method: "POST",
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          Prefer: "return=minimal",
        },
        body: JSON.stringify(dados),
      });

      if (response.ok) {
        showToast("✅ Sua solicitação foi registrada com sucesso!");
        form.reset();
      } else {
        const erro = await response.text();
        console.error("Erro do Supabase:", erro);
        showToast("❌ Erro ao enviar. Verifique os dados.", "error");
      }
    } catch (erro) {
      console.error("Erro de rede:", erro);
      showToast("⚠️ Falha de conexão. Tente novamente.", "error");
    } finally {
      botao.disabled = false;
      botao.textContent = "Enviar Solicitação";
    }
  });
</script>
</body>
</html>
